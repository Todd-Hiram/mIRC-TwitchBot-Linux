on *:text:!timer *:#: {
  if ($msgtags(mod).key == 1) {
    if (add == $2) {
      set %timer.channel. [ $+ [ $me ] ] 
      var %r = $read(# $+ timers.txt,ns,$3)
      if (%r) { .msg $chan [ $+ $nick $+ ] : Error, This timer $qt($3) is already exist into the database! | return }
      if ($4 < 60) { msg # Timer is set too low, please inscrease the amount of seconds the timer should run at. }
      write # $+ timers.txt $3-
      timer $+ $3 $+ $me 0 $4 TimerRun $3
      msg $chan /me + Timer $3 has been added to the database!
    }
    if (del == $2) {
      var %r = $read(# $+ timers.txt,ns,$3)
      if (!%r) { .msg $chan [ $+ $nick $+ ]: Error, This timer $qt($3) does NOT exist into the database! | return }
      write -dl $+ $readn # $+ timers.txt
      timer $+ $3 $+ $me off
      msg $chan /me - Timer $3- has been deleted from the database!
    }
    if (edit == $2) {
      var %r = $read(# $+ timers.txt,ns,$3)
      if (!%r) { .msg $chan [ $+ $nick $+ ]: Error, This timer $qt($3) does NOT exist into the database! | return }
      write -l $+ $readn # $+ timers.txt $3-
      timer $+ $3 $+ $me 0 $4 TimerRun $3
      msg $chan /me -> Timer $3 has been updated!
    }
    if ($2 == on) {
      var %r = $read(# $+ timers.txt,ns,$3)
      if (!%r) { .msg $chan [ $+ $nick $+ ]: Error, This timer $qt($3) does NOT exist into the database! | return }
      elseif ($timer($3 $+ $chan) != $null) { msg # Timer $3 is already on! }
      else {
        var %timermessage $read(# $+ timers.txt,ns,$3)
        timer $+ $3 $+ $me 0 $gettok(%timermessage,1,32) TimerRun $3
        msg $chan /me -> Timer $3 has been turned on!
      }
    }
    if ($2 == off) {
      var %r = $read(# $+ timers.txt,ns,$3)
      if (!%r) { .msg $chan [ $+ $nick $+ ]: Error, This timer $qt($3) does NOT exist into the database! | return }
      elseif ($timer($3 $+ $chan) == $null) { msg # Timer $3 is already off! }
      else {
        timer $+ $3 $+ $me off
        msg $chan /me -> Timer $3 has been turned off!
      }
    }
  }
}

on *:join:#:{
  if ($nick == $me) {
    set %timer.channel. [ $+ [ $me ] ] $chan
    set %timer. [ $+ [ $me ] ] 0
    set %amountoftimers. [ $+ [ $me ] ] $lines(# $+ timers.txt)
    var %x. [ $+ [ $me ] ] $lines(# $+ timers.txt)
    while (%x. [ $+ [ $me ] ]  > 0) {
      var %timermessage $read(# $+ timers.txt, n, %x. [ $+ [ $me ] ] )
      var %time = $gettok(%timermessage,2,32)
      var %timer. [ $+ [ $me ] ] $calc(%timer. [ $+ [ $me ] ] + %time )
      dec %x. [ $+ [ $me ] ] 
    }
    if (%amountoftimers. [ $+ [ $me ] ] == 0)  { return }
    var %avgtime. [ $+ [ # ] ] $calc(%timer. [ $+ [ $me ] ] / $calc( $lines(# $+ timers.txt) * 7))
    timerfloodtimer. [ $+ [ $me ] ] %amountoftimers. [ $+ [ $me ] ] %avgtime. [ $+ [ # ] ]  timeropen
  }
}

alias timeropen { 
  if (%amountoftimers. $+ $me > 0) {
    var %timermessagespecific $read(%timer.channel. [ $+ [ $me ] ] $+ timers.txt,n,%amountoftimers. [ $+ [ $me ] ] )
    timer $+ $gettok(%timermessagespecific,1,32) $+ $me 0 $gettok(%timermessagespecific, 2,32) TimerRun $gettok(%timermessagespecific,1,32)
    dec %amountoftimers. [ $+ [ $me ] ]
  }
}

alias TimerRun {
  if (%chat. [ $+ [ $me ] ] >= 1) {
    var %timermessagespecific. $read(%timer.channel. [ $+ [ $me ] ] $+ timers.txt,ns, $1)
    msg %timer.channel. [ $+ [ $me ] ] $gettok(%timermessagespecific.,2-,32)
    set %chat. [ $+ [ $me ] ] 0
  }
}
on *:text:*:#:{
  if ($nick != $me) {
    set %chat. [ $+ [ $me ] ] 1
  }
}
